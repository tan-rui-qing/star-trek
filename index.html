<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAR-TIRK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Consolas", monospace;
        }

        body {
            background: linear-gradient(to bottom, #eee, #000);
            background-size: 100% 200%;
            animation: bgFade 3s ease-in-out forwards;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        @keyframes bgFade {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 100%; }
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            border: 1px solid #333;
            transform: translateZ(0); /* ç¡¬ä»¶åŠ é€Ÿ */
            will-change: transform;
        }

        #player {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            z-index: 100;
            user-select: none;
            transform: translateZ(0);
        }

        .bullet {
            position: absolute;
            color: #ff4500;
            font-size: 24px;
            user-select: none;
            z-index: 50;
            transform: translateZ(0);
        }

        .missile {
            position: absolute;
            color: #0f0;
            font-size: 20px;
            user-select: none;
            z-index: 50;
            transform: translateZ(0);
        }

        .meteor {
            position: absolute;
            font-size: 40px; /* é™¨çŸ³å°ºå¯¸å¤§äºé£èˆ¹ */
            font-weight: bold;
            user-select: none;
            z-index: 40;
            animation: spin 2s linear infinite;
            transform: translateZ(0);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            z-index: 200;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
        }

        #talent-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            padding: 20px;
            z-index: 300;
            text-align: center;
            display: none;
        }

        .talent-btn {
            display: block;
            width: 280px;
            padding: 12px;
            margin: 12px auto;
            background: #222;
            color: #fff;
            border: 1px solid #fff;
            cursor: pointer;
            font-size: 16px;
        }

        .talent-btn:hover {
            background: #444;
        }

        #game-over-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            padding: 30px;
            z-index: 300;
            text-align: center;
            display: none;
        }

        #restart-btn {
            padding: 10px 20px;
            margin-top: 20px;
            background: #222;
            color: #fff;
            border: 1px solid #fff;
            cursor: pointer;
            font-size: 18px;
        }

        #restart-btn:hover {
            background: #444;
        }

        /* çƒŸèŠ±çˆ†ç‚¸ç‰¹æ•ˆ */
        .firework {
            position: absolute;
            pointer-events: none;
            z-index: 150;
        }

        .firework-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: explode 0.8s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* é©¬å¹´ç¥ç¦è¯­ */
        .wish-text {
            position: absolute;
            color: #ffd700;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px #ff4500;
            pointer-events: none;
            z-index: 160;
            animation: floatUp 1.5s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(1.2);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- ç©å®¶é£èˆ¹ -->
        <div id="player">A</div>
        
        <!-- ä¿¡æ¯é¢æ¿ï¼šæ–°å¢å­å¼¹/å¼¹å¤¹/å¯¼å¼¹æ˜¾ç¤º -->
        <div id="info-panel">
            ç©å®¶ï¼š<span id="player-name">æœªçŸ¥</span><br>
            å½“å‰è·ç¦»ï¼š<span id="current-distance">0</span> ç±³<br>
            æœ€é«˜è·ç¦»ï¼š<span id="max-distance">0</span> ç±³<br>
            å­å¼¹ï¼š<span id="current-ammo">50</span>/<span id="max-ammo">50</span><br>
            å¯¼å¼¹ï¼š<span id="current-missile">3</span>/<span id="max-missile">3</span>
        </div>

        <!-- å¤©èµ‹é€‰æ‹©é¢æ¿ -->
        <div id="talent-panel">
            <h2>é€‰æ‹©ä½ çš„å¤©èµ‹ï¼ˆ3é€‰1ï¼‰</h2>
            <button class="talent-btn" id="talent1"></button>
            <button class="talent-btn" id="talent2"></button>
            <button class="talent-btn" id="talent3"></button>
        </div>

        <!-- æ¸¸æˆç»“æŸé¢æ¿ -->
        <div id="game-over-panel">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <p>ç©å®¶ï¼š<span id="go-name">æœªçŸ¥</span></p>
            <p>æœ¬æ¬¡é£è¡Œè·ç¦»ï¼š<span id="go-distance">0</span> ç±³</p>
            <p>å†å²æœ€é«˜ï¼š<span id="go-max-distance">0</span> ç±³</p>
            <p>å·²é€‰å¤©èµ‹ï¼š<span id="go-talents">æ— </span></p>
            <button id="restart-btn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒå˜é‡å®šä¹‰ ==========
        const gameContainer = document.getElementById('game-container');
        const player = document.getElementById('player');
        const talentPanel = document.getElementById('talent-panel');
        const gameOverPanel = document.getElementById('game-over-panel');
        const restartBtn = document.getElementById('restart-btn');

        // ç©å®¶ç›¸å…³
        let playerName = '';
        let playerX = gameContainer.clientWidth / 2 - 12;
        const playerY = gameContainer.clientHeight - 60;
        let playerSpeed = 30; // ç©å®¶é£æœºé€Ÿåº¦æ”¹ä¸º30
        let playerWidth = 24;
        let playerHeight = 24;

        // é”®ç›˜çŠ¶æ€è®°å½•ï¼ˆè§£å†³ç§»åŠ¨å¡é¡¿ï¼‰
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            a: false,
            d: false
        };
        let isFiring = false; // è®°å½•æ˜¯å¦åœ¨å¼€æª
        let isFiringMissile = false; // è®°å½•æ˜¯å¦åœ¨å‘å°„å¯¼å¼¹

        // æ¸¸æˆçŠ¶æ€
        let gameRunning = false;
        let currentDistance = 0;
        let maxDistance = localStorage.getItem('planeGameMaxDistance') || 0;
        let distanceTimer = null;
        let meteorTimer = null;
        let moveTimer = null;
        let reloadTimer = null; // è£…å¼¹å®šæ—¶å™¨
        let missileReloadTimer = null; // å¯¼å¼¹è£…å¼¹å®šæ—¶å™¨
        let fireCD = false;
        let fireInterval = 300;
        let gameTime = 0; // æ¸¸æˆæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        // ========== å¼¹å¤¹ç³»ç»Ÿæ ¸å¿ƒå˜é‡ ==========
        let maxAmmo = 50; // åˆå§‹å¼¹å¤¹å®¹é‡æ”¹ä¸º50
        let currentAmmo = 50; // å½“å‰å­å¼¹æ•°
        let reloadTime = 1000; // åˆå§‹è£…å¼¹å†·å´æ”¹ä¸º1ç§’/å‘

        // ========== å¯¼å¼¹ç³»ç»Ÿæ ¸å¿ƒå˜é‡ ==========
        let missiles = [];
        let currentMissile = 3; // åˆå§‹å¯¼å¼¹æ§½ä½3å‘
        let maxMissile = 3; // æœ€å¤§å¯¼å¼¹æ§½ä½
        let missileReloadTime = 5000; // å¯¼å¼¹æ¢å¤å†·å´5ç§’/å‘
        let missileFireCD = false;
        let missileFireInterval = 300;

        // ========== é™¨çŸ³ç³»ç»Ÿæ ¸å¿ƒå˜é‡ ==========
        const meteorMinCount = 30;
        const meteorMaxCount = 100;
        const meteorMinSpeed = 5;
        const meteorMaxSpeed = 10;
        const meteorMinHp = 1;
        const meteorMaxHp = 10;

        // å­å¼¹/é™¨çŸ³æ•°ç»„
        let bullets = [];
        let meteors = [];

        // ========== å¤©èµ‹ç³»ç»Ÿï¼ˆæ”¯æŒç´¯åŠ ï¼‰ ==========
        const talentList = [
            { id: 1, name: "åŒå€å°„é€Ÿ", desc: "å¼€ç«é—´éš”å‡åŠï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { fireInterval = Math.max(50, fireInterval / 2); } },
            { id: 2, name: "åŒå‘å­å¼¹", desc: "æ¯æ¬¡å¼€ç«å‘å°„2æŸå­å¼¹ï¼ˆä»…è€—1æ§½ï¼‰", effect: () => { window.doubleBullet = true; } },
            { id: 3, name: "ç§»åŠ¨åŠ é€Ÿ", desc: "é£èˆ¹ç§»åŠ¨é€Ÿåº¦+5ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { playerSpeed += 5; } },
            { id: 4, name: "æŠ¤ç›¾", desc: "æŠµæŒ¡1æ¬¡é™¨çŸ³æ’å‡»ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { window.shieldCount = (window.shieldCount || 0) + 1; } },
            { id: 5, name: "å­å¼¹ç©¿é€", desc: "å­å¼¹å¯å‡»ä¸­å¤šä¸ªé™¨çŸ³ï¼ˆå¯ç´¯åŠ ï¼Œä¸Šé™+2ï¼‰", effect: () => { 
                window.bulletPenetrate = true;
                window.penetrateMax = (window.penetrateMax || 3) + 2;
            } },
            { id: 6, name: "é™¨çŸ³å‡é€Ÿ", desc: "æ‰€æœ‰é™¨çŸ³é€Ÿåº¦-3ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { window.meteorSpeedReduce = (window.meteorSpeedReduce || 0) + 3; } },
            { id: 7, name: "åŒå€è·ç¦»", desc: "æ¯ç§’å¢åŠ çš„è·ç¦»ç¿»å€ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                window.doubleDistanceCount = (window.doubleDistanceCount || 0) + 1;
            } },
            { id: 8, name: "çˆ†ç‚¸å­å¼¹", desc: "å‡»ä¸­é™¨çŸ³æ—¶é”€æ¯å‘¨å›´é™¨çŸ³ï¼ˆèŒƒå›´+20ï¼‰", effect: () => { 
                window.explodeBullet = true;
                window.explodeRange = (window.explodeRange || 50) + 20;
            } },
            { id: 9, name: "è‡ªåŠ¨å¼€ç«", desc: "æ— éœ€æŒ‰ç©ºæ ¼è‡ªåŠ¨å¼€ç«", effect: () => { window.autoFire = true; } },
            { id: 10, name: "å­å¼¹åŠ é€Ÿ", desc: "å­å¼¹é£è¡Œé€Ÿåº¦+6ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { window.bulletSpeed = (window.bulletSpeed || 10) + 6; } },
            { id: 11, name: "ç©å®¶å˜å¤§", desc: "é£èˆ¹ä½“ç§¯å˜å¤§ï¼Œç§»åŠ¨+3ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                player.style.fontSize = `${parseInt(player.style.fontSize || 24) + 6}px`; 
                playerSpeed += 3; 
                playerWidth += 6; 
                playerHeight += 6; 
            } },
            { id: 12, name: "é™¨çŸ³å˜å°‘", desc: "é™¨çŸ³ç”Ÿæˆé—´éš”+50msï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                window.meteorSpawnDelay = (window.meteorSpawnDelay || 0) + 50;
                resetMeteorTimer();
            } },
            { id: 13, name: "ä¸´æ—¶æ— æ•Œ", desc: "5ç§’å†…å…ç–«æ‰€æœ‰ä¼¤å®³ï¼ˆå¯ç´¯åŠ æ—¶é•¿ï¼‰", effect: () => { 
                window.invincible = true; 
                const currentInvincibleTime = (window.invincibleTimer || 5000) + 5000;
                clearTimeout(window.invincibleTimeout);
                window.invincibleTimeout = setTimeout(() => { window.invincible = false; }, currentInvincibleTime);
            } },
            { id: 14, name: "åˆ†æ•°ç¿»å€", desc: "å½“å‰è·ç¦»ç›´æ¥ç¿»å€ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { currentDistance = Math.floor(currentDistance * 2); updateInfoPanel(); } },
            { id: 15, name: "åå‘é™¨çŸ³", desc: "åå‘é™¨çŸ³æ¦‚ç‡+10%ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { window.reverseMeteorRate = (window.reverseMeteorRate || 0.3) + 0.1; } },
            { id: 16, name: "å­å¼¹è¿½è¸ª", desc: "è¿½è¸ªé€Ÿåº¦+1ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                window.bulletTrack = true;
                window.trackSpeed = (window.trackSpeed || 1) + 1;
            } },
            { id: 17, name: "æŠ¤ç›¾å†ç”Ÿ", desc: "æŠ¤ç›¾å†ç”Ÿé—´éš”-200ç±³ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                window.shieldRegen = true;
                window.shieldRegenStep = (window.shieldRegenStep || 1000) - 200;
            } },
            { id: 18, name: "é™¨çŸ³åˆ†è£‚", desc: "åˆ†è£‚é™¨çŸ³æ•°é‡+1ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                window.meteorSplit = true;
                window.splitCount = (window.splitCount || 2) + 1;
            } },
            { id: 19, name: "æ‰©å……å¼¹å¤¹", desc: "å¼¹å¤¹å®¹é‡+50ï¼ˆå¯ç´¯åŠ ï¼‰", effect: () => { 
                maxAmmo = maxAmmo + 50;
                currentAmmo = Math.min(maxAmmo, currentAmmo + 50);
                updateInfoPanel();
            } },
            { id: 20, name: "å¿«é€Ÿè£…å¼¹", desc: "è£…å¼¹å†·å´-0.25ç§’ï¼ˆæœ€ä½0.5ç§’ï¼Œå¯ç´¯åŠ ï¼‰", effect: () => { 
                reloadTime = Math.max(500, reloadTime - 250);
                if (reloadTimer) clearInterval(reloadTimer);
                startReloadTimer();
            } },
            { id: 21, name: "å¿«é€Ÿå¯¼å¼¹å†·å´", desc: "å¯¼å¼¹æ¢å¤å†·å´-1ç§’ï¼ˆæœ€ä½1ç§’ï¼Œå¯ç´¯åŠ ï¼‰", effect: () => { 
                missileReloadTime = Math.max(1000, missileReloadTime - 1000);
                if (missileReloadTimer) clearInterval(missileReloadTimer);
                startMissileReloadTimer();
            } },
            { id: 22, name: "æ‰©å……å¯¼å¼¹æ§½ä½", desc: "å¯¼å¼¹æ§½ä½+1ï¼ˆæœ€å¤š5ï¼Œå¯ç´¯åŠ ï¼‰", effect: () => { 
                maxMissile = Math.min(5, maxMissile + 1);
                currentMissile = Math.min(maxMissile, currentMissile + 1);
                updateInfoPanel();
            } }
        ];
        let selectedTalents = [];

        // å¤©èµ‹æ•ˆæœå…¨å±€å˜é‡ï¼ˆåˆå§‹å€¼ï¼‰
        window.doubleBullet = false;
        window.tripleBullet = false;
        window.bulletPenetrate = false;
        window.penetrateMax = 3;
        window.meteorSpeedReduce = 0;
        window.doubleDistanceCount = 0;
        window.explodeBullet = false;
        window.explodeRange = 50;
        window.autoFire = false;
        window.bulletSpeed = 10;
        window.invincible = false;
        window.reverseMeteorRate = 0.3;
        window.bulletTrack = false;
        window.trackSpeed = 1;
        window.shieldRegen = false;
        window.shieldRegenStep = 1000;
        window.meteorSplit = false;
        window.splitCount = 2;
        window.shieldCount = 0;
        window.meteorSpawnDelay = 0;

        // ========== åˆå§‹åŒ–å‡½æ•° ==========
        function initGame() {
            resetGameState();
            
            playerName = prompt("è¯·è¾“å…¥ä½ çš„åå­—ï¼š", "é£è¡Œå‘˜");
            if (!playerName) playerName = "åŒ¿åç©å®¶";
            document.getElementById('player-name').textContent = playerName;
            
            playerX = gameContainer.clientWidth / 2 - playerWidth / 2;
            player.style.left = `${playerX}px`;
            player.style.top = `${playerY}px`;
            
            showTalentPanel();
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGameState() {
            clearInterval(distanceTimer);
            clearInterval(meteorTimer);
            clearInterval(moveTimer);
            clearInterval(reloadTimer);
            clearInterval(missileReloadTimer);
            clearTimeout(window.invincibleTimeout);
            
            bullets.forEach(bullet => gameContainer.removeChild(bullet.element));
            missiles.forEach(missile => gameContainer.removeChild(missile.element));
            meteors.forEach(meteor => gameContainer.removeChild(meteor.element));
            bullets = [];
            missiles = [];
            meteors = [];
            
            currentDistance = 0;
            gameTime = 0;
            gameRunning = false;
            fireCD = false;
            missileFireCD = false;
            fireInterval = 300;
            playerSpeed = 30;
            selectedTalents = [];
            isFiring = false;
            isFiringMissile = false;
            
            maxAmmo = 50;
            currentAmmo = 50;
            reloadTime = 1000;
            
            currentMissile = 3;
            maxMissile = 3;
            missileReloadTime = 5000;
            
            window.doubleBullet = false;
            window.tripleBullet = false;
            window.bulletPenetrate = false;
            window.penetrateMax = 3;
            window.meteorSpeedReduce = 0;
            window.doubleDistanceCount = 0;
            window.explodeBullet = false;
            window.explodeRange = 50;
            window.autoFire = false;
            window.bulletSpeed = 10;
            window.invincible = false;
            window.reverseMeteorRate = 0.3;
            window.bulletTrack = false;
            window.trackSpeed = 1;
            window.shieldRegen = false;
            window.shieldRegenStep = 1000;
            window.meteorSplit = false;
            window.splitCount = 2;
            window.shieldCount = 0;
            window.meteorSpawnDelay = 0;
            
            for (let key in keys) {
                keys[key] = false;
            }
            
            player.style.fontSize = "24px";
            playerWidth = 24;
            playerHeight = 24;
            talentPanel.style.display = "none";
            gameOverPanel.style.display = "none";
            updateInfoPanel();
        }

        // ========== å¤©èµ‹ç³»ç»Ÿï¼ˆæ”¯æŒç´¯åŠ ï¼‰ ==========
        function showTalentPanel() {
            const shuffledTalents = [...talentList].sort(() => Math.random() - 0.5).slice(0, 3);
            
            document.getElementById('talent1').textContent = `${shuffledTalents[0].name}ï¼š${shuffledTalents[0].desc}`;
            document.getElementById('talent2').textContent = `${shuffledTalents[1].name}ï¼š${shuffledTalents[1].desc}`;
            document.getElementById('talent3').textContent = `${shuffledTalents[2].name}ï¼š${shuffledTalents[2].desc}`;
            
            document.getElementById('talent1').onclick = () => selectTalent(shuffledTalents[0]);
            document.getElementById('talent2').onclick = () => selectTalent(shuffledTalents[1]);
            document.getElementById('talent3').onclick = () => selectTalent(shuffledTalents[2]);
            
            talentPanel.style.display = "block";
        }

        function selectTalent(talent) {
            selectedTalents.push(talent.name);
            talent.effect();
            talentPanel.style.display = "none";
            if (!gameRunning) {
                startGame();
            }
        }

        // ========== è£…å¼¹å®šæ—¶å™¨ï¼ˆä»…æœªå¼€æªæ—¶æ¢å¤ï¼‰ ==========
        function startReloadTimer() {
            reloadTimer = setInterval(() => {
                if (gameRunning && currentAmmo < maxAmmo && !isFiring) {
                    currentAmmo += 1;
                    updateInfoPanel();
                }
            }, reloadTime);
        }

        // ========== å¯¼å¼¹è£…å¼¹å®šæ—¶å™¨ï¼ˆä»…æœªå‘å°„æ—¶æ¢å¤ï¼‰ ==========
        function startMissileReloadTimer() {
            missileReloadTimer = setInterval(() => {
                if (gameRunning && currentMissile < maxMissile && !isFiringMissile) {
                    currentMissile += 1;
                    updateInfoPanel();
                }
            }, missileReloadTime);
        }

        // ========== é‡ç½®é™¨çŸ³å®šæ—¶å™¨ï¼ˆé€‚é…å¤©èµ‹ç´¯åŠ ï¼‰ ==========
        function resetMeteorTimer() {
            clearInterval(meteorTimer);
            const finalSpawnRate = 250 + window.meteorSpawnDelay;
            meteorTimer = setInterval(spawnMeteor, finalSpawnRate);
        }

        // ========== è·å–é™¨çŸ³å‚æ•°ï¼ˆéšæ¸¸æˆæ—¶é—´å˜åŒ–ï¼‰ ==========
        function getMeteorParams() {
            const seconds = gameTime / 1000;
            return {
                count: Math.min(meteorMaxCount, Math.floor(meteorMinCount + seconds / 2)),
                speed: Math.min(meteorMaxSpeed, Math.floor(meteorMinSpeed + seconds / 5)),
                hp: Math.min(meteorMaxHp, Math.floor(meteorMinHp + seconds / 30))
            };
        }

        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        function startGame() {
            gameRunning = true;
            
            distanceTimer = setInterval(() => {
                gameTime += 1000;
                const distanceMulti = Math.pow(2, window.doubleDistanceCount);
                currentDistance += 50 * distanceMulti;
                
                if (currentDistance % 500 === 0 && currentDistance > 0) {
                    pauseGame();
                    showTalentPanel();
                }
                
                if (window.shieldRegen && currentDistance % window.shieldRegenStep === 0 && currentDistance > 0) {
                    window.shieldCount += 1;
                }
                
                updateInfoPanel();
            }, 1000);
            
            resetMeteorTimer();
            
            moveTimer = setInterval(() => {
                moveObjects();
                handlePlayerMove();
            }, 10);
            
            startReloadTimer();
            startMissileReloadTimer();
            
            if (window.autoFire) {
                setInterval(() => {
                    if (gameRunning && !fireCD && currentAmmo > 0) {
                        fire();
                    }
                }, fireInterval);
            }
        }

        function pauseGame() {
            gameRunning = false;
            clearInterval(distanceTimer);
            clearInterval(meteorTimer);
            clearInterval(moveTimer);
            clearInterval(reloadTimer);
            clearInterval(missileReloadTimer);
        }

        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfoPanel() {
            document.getElementById('current-distance').textContent = currentDistance;
            document.getElementById('max-distance').textContent = maxDistance;
            document.getElementById('current-ammo').textContent = currentAmmo;
            document.getElementById('max-ammo').textContent = maxAmmo;
            document.getElementById('current-missile').textContent = currentMissile;
            document.getElementById('max-missile').textContent = maxMissile;
        }

        // ç”Ÿæˆé™¨çŸ³ï¼šã€æ ¸å¿ƒä¿®æ”¹ã€‘70%æ¦‚ç‡åœ¨ç©å®¶å‘¨å›´ç”Ÿæˆ
        function spawnMeteor() {
            if (!gameRunning) return;
            const params = getMeteorParams();
            if (meteors.length >= params.count) return;
            
            const charCode = Math.floor(Math.random() * 26) + 65;
            const meteorChar = String.fromCharCode(charCode);
            const meteor = document.createElement('div');
            meteor.className = 'meteor';
            meteor.textContent = meteorChar;
            
            // --- æ ¸å¿ƒä¿®æ”¹å¼€å§‹ï¼šè®©é™¨çŸ³æ›´å¤šåœ¨ç©å®¶å‘¨å›´ç”Ÿæˆ ---
            let meteorX;
            if (Math.random() < 0.7) {
                // 70%çš„æ¦‚ç‡åœ¨ç©å®¶å·¦å³150åƒç´ èŒƒå›´å†…ç”Ÿæˆ
                const offset = (Math.random() - 0.5) * 300; // åç§»èŒƒå›´ï¼š-150 åˆ° 150
                meteorX = playerX + offset;
                // ç¡®ä¿ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
                meteorX = Math.max(0, Math.min(gameContainer.clientWidth - 60, meteorX));
            } else {
                // 30%çš„æ¦‚ç‡åœ¨æ•´ä¸ªå±å¹•éšæœºç”Ÿæˆ
                meteorX = Math.random() * (gameContainer.clientWidth - 60);
            }
            // --- æ ¸å¿ƒä¿®æ”¹ç»“æŸ ---

            const meteorY = -60;
            meteor.style.left = `${meteorX}px`;
            meteor.style.top = `${meteorY}px`;
            const size = Math.floor(Math.random() * 20) + 40;
            meteor.style.fontSize = `${size}px`;
            
            let speed = params.speed * (0.8 + Math.random() * 0.4) - window.meteorSpeedReduce;
            speed = Math.max(meteorMinSpeed, Math.min(meteorMaxSpeed, speed));
            
            if (Math.random() < window.reverseMeteorRate) {
                speed = -speed;
            }
            
            meteors.push({
                element: meteor,
                x: meteorX,
                y: meteorY,
                speed: speed,
                width: size,
                height: size,
                hp: params.hp,
                maxHp: params.hp
            });
            
            gameContainer.appendChild(meteor);
        }

        // å¼€ç«é€»è¾‘ï¼šåŒå€/ä¸‰å€ç´¯åŠ ï¼Œæœ€å¤š10å‘
        function fire() {
            if (fireCD || !gameRunning || currentAmmo <= 0) return;
            
            fireCD = true;
            setTimeout(() => {
                fireCD = false;
            }, fireInterval);
            
            currentAmmo = Math.max(0, currentAmmo - 1);
            updateInfoPanel();
            
            const baseX = playerX + playerWidth / 2 - 2;
            const baseY = playerY - 20;
            
            let bulletCount = 1;
            if (window.doubleBullet) bulletCount *= 2;
            if (window.tripleBullet) bulletCount *= 3;
            bulletCount = Math.min(bulletCount, 10); // æœ€å¤š10å‘
            
            for (let i = 0; i < bulletCount; i++) {
                const offsetX = (i - (bulletCount - 1) / 2) * 10;
                const bulletX = baseX + offsetX;
                
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                bullet.textContent = 'ğŸ§¨';
                bullet.style.left = `${bulletX}px`;
                bullet.style.top = `${baseY}px`;
                
                bullets.push({
                    element: bullet,
                    x: bulletX,
                    y: baseY,
                    speed: window.bulletSpeed
                });
                
                gameContainer.appendChild(bullet);
            }
        }

        // å‘å°„å¯¼å¼¹é€»è¾‘
        function fireMissile() {
            if (missileFireCD || !gameRunning || currentMissile <= 0) return;
            
            missileFireCD = true;
            setTimeout(() => {
                missileFireCD = false;
            }, missileFireInterval);
            
            currentMissile = Math.max(0, currentMissile - 1);
            updateInfoPanel();
            
            const side = Math.random() > 0.5 ? 1 : -1;
            const missileX = playerX + playerWidth / 2;
            const missileY = playerY + playerHeight / 2;
            
            const missile = document.createElement('div');
            missile.className = 'missile';
            missile.textContent = 'â–¶';
            missile.style.left = `${missileX}px`;
            missile.style.top = `${missileY}px`;
            
            missiles.push({
                element: missile,
                x: missileX,
                y: missileY,
                side: side,
                state: 'idle',
                idleTime: 300,
                speed: 0,
                maxSpeed: 10,
                damage: 11
            });
            
            gameContainer.appendChild(missile);
        }

        // åˆ›å»ºçƒŸèŠ±çˆ†ç‚¸ç‰¹æ•ˆå’Œé©¬å¹´ç¥ç¦è¯­
        function createFirework(x, y) {
            // çƒŸèŠ±ç²’å­é¢œè‰²
            const colors = ['#ff0000', '#ffd700', '#ff4500', '#00ff00', '#00bfff', '#ff1493'];
            const particleCount = 12;
            
            // åˆ›å»ºçƒŸèŠ±å®¹å™¨
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = `${x}px`;
            firework.style.top = `${y}px`;
            gameContainer.appendChild(firework);
            
            // ç”Ÿæˆç²’å­
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // è®¡ç®—ç²’å­é£æ•£çš„è§’åº¦å’Œè·ç¦»
                const angle = (i / particleCount) * Math.PI * 2;
                const distance = 50 + Math.random() * 30;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                firework.appendChild(particle);
            }
            
            // é©¬å¹´ç¥ç¦è¯­
            const wishes = ['é©¬åˆ°æˆåŠŸï¼', 'é¾™é©¬ç²¾ç¥ï¼', 'ä¸€é©¬å½“å…ˆï¼', 'é©¬å¹´å¤§å‰ï¼', 'ç­–é©¬å¥”è…¾ï¼'];
            const wishText = document.createElement('div');
            wishText.className = 'wish-text';
            wishText.textContent = wishes[Math.floor(Math.random() * wishes.length)];
            wishText.style.left = `${x - 40}px`;
            wishText.style.top = `${y - 20}px`;
            gameContainer.appendChild(wishText);
            
            // ç§»é™¤å…ƒç´ ï¼Œé¿å…å†…å­˜æ³„æ¼
            setTimeout(() => {
                gameContainer.removeChild(firework);
                gameContainer.removeChild(wishText);
            }, 1500);
        }

        function moveObjects() {
            if (!gameRunning) return;
            
            // ç§»åŠ¨å­å¼¹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.y -= bullet.speed;
                bullet.element.style.top = `${bullet.y}px`;
                
                if (window.bulletTrack && meteors.length > 0) {
                    let closestMeteor = meteors[0];
                    let minDistance = Infinity;
                    meteors.forEach(meteor => {
                        const dx = meteor.x - bullet.x;
                        const dy = meteor.y - bullet.y;
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestMeteor = meteor;
                        }
                    });
                    if (bullet.x < closestMeteor.x) bullet.x += window.trackSpeed;
                    else if (bullet.x > closestMeteor.x) bullet.x -= window.trackSpeed;
                    bullet.element.style.left = `${bullet.x}px`;
                }
                
                if (bullet.y < -20) {
                    gameContainer.removeChild(bullet.element);
                    bullets.splice(i, 1);
                    continue;
                }
                
                checkBulletCollision(i);
            }

            // ç§»åŠ¨å¯¼å¼¹
            for (let i = missiles.length - 1; i >= 0; i--) {
                const missile = missiles[i];
                if (missile.state === 'idle') {
                    missile.x += missile.side * 2;
                    missile.idleTime -= 10;
                    if (missile.idleTime <= 0) {
                        missile.state = 'launch';
                        missile.speed = missile.maxSpeed;
                    }
                } else {
                    missile.y -= missile.speed;
                }
                missile.element.style.left = `${missile.x}px`;
                missile.element.style.top = `${missile.y}px`;
                
                if (missile.y < -20) {
                    gameContainer.removeChild(missile.element);
                    missiles.splice(i, 1);
                    continue;
                }
                
                checkMissileCollision(i);
            }
            
            // ç§»åŠ¨é™¨çŸ³
            for (let i = meteors.length - 1; i >= 0; i--) {
                const meteor = meteors[i];
                meteor.y += meteor.speed;
                meteor.element.style.top = `${meteor.y}px`;
                
                if (meteor.y > gameContainer.clientHeight + 60 || (meteor.speed < 0 && meteor.y < -60)) {
                    gameContainer.removeChild(meteor.element);
                    meteors.splice(i, 1);
                    continue;
                }
                
                checkMeteorCollision(meteor);
            }
        }

        // é£èˆ¹ç§»åŠ¨
        function handlePlayerMove() {
            if (!gameRunning) return;
            
            if ((keys.a || keys.ArrowLeft) && playerX > 0) {
                playerX = Math.max(0, playerX - playerSpeed * 0.15);
                player.style.left = `${playerX}px`;
            }
            if ((keys.d || keys.ArrowRight) && playerX < gameContainer.clientWidth - playerWidth) {
                playerX = Math.min(gameContainer.clientWidth - playerWidth, playerX + playerSpeed * 0.15);
                player.style.left = `${playerX}px`;
            }
        }

        // å­å¼¹ç¢°æ’æ£€æµ‹ï¼ˆè€ƒè™‘é™¨çŸ³è¡€é‡ï¼‰
        function checkBulletCollision(bulletIndex) {
            const bullet = bullets[bulletIndex];
            let hitCount = 0;
            
            for (let i = meteors.length - 1; i >= 0; i--) {
                const meteor = meteors[i];
                if (
                    bullet.x < meteor.x + meteor.width &&
                    bullet.x + 4 > meteor.x &&
                    bullet.y < meteor.y + meteor.height &&
                    bullet.y + 18 > meteor.y
                ) {
                    meteor.hp -= 1;
                    hitCount++;
                    
                    if (meteor.hp <= 0) {
                        gameContainer.removeChild(meteor.element);
                        meteors.splice(i, 1);
                        
                        // åˆ›å»ºçƒŸèŠ±ç‰¹æ•ˆ
                        createFirework(meteor.x + meteor.width / 2, meteor.y + meteor.height / 2);
                        
                        if (window.explodeBullet) {
                            for (let j = meteors.length - 1; j >= 0; j--) {
                                const m = meteors[j];
                                const dx = m.x - meteor.x;
                                const dy = m.y - meteor.y;
                                if (Math.sqrt(dx*dx + dy*dy) < window.explodeRange) {
                                    gameContainer.removeChild(m.element);
                                    meteors.splice(j, 1);
                                    // ä¸ºè¿é”çˆ†ç‚¸ä¹Ÿåˆ›å»ºçƒŸèŠ±
                                    createFirework(m.x + m.width / 2, m.y + m.height / 2);
                                }
                            }
                        }
                        
                        if (window.meteorSplit) {
                            for (let s = 0; s < window.splitCount; s++) {
                                const smallMeteor = document.createElement('div');
                                smallMeteor.className = 'meteor';
                                smallMeteor.textContent = String.fromCharCode(Math.floor(Math.random() * 26) + 65);
                                smallMeteor.style.left = `${meteor.x + (s - 1) * 15}px`;
                                smallMeteor.style.top = `${meteor.y}px`;
                                smallMeteor.style.fontSize = "30px";
                                gameContainer.appendChild(smallMeteor);
                                meteors.push({
                                    element: smallMeteor,
                                    x: meteor.x + (s - 1) * 15,
                                    y: meteor.y,
                                    speed: meteor.speed + 2,
                                    width: 30,
                                    height: 30,
                                    hp: 1,
                                    maxHp: 1
                                });
                            }
                        }
                    }
                    
                    if (!window.bulletPenetrate || hitCount >= window.penetrateMax) {
                        gameContainer.removeChild(bullet.element);
                        bullets.splice(bulletIndex, 1);
                        break;
                    }
                }
            }
        }

        // å¯¼å¼¹ç¢°æ’æ£€æµ‹ï¼ˆä¼¤å®³11ï¼‰
        function checkMissileCollision(missileIndex) {
            const missile = missiles[missileIndex];
            for (let i = meteors.length - 1; i >= 0; i--) {
                const meteor = meteors[i];
                if (
                    missile.x < meteor.x + meteor.width &&
                    missile.x + 20 > meteor.x &&
                    missile.y < meteor.y + meteor.height &&
                    missile.y + 20 > meteor.y
                ) {
                    meteor.hp -= missile.damage;
                    
                    if (meteor.hp <= 0) {
                        gameContainer.removeChild(meteor.element);
                        meteors.splice(i, 1);
                        
                        // åˆ›å»ºçƒŸèŠ±ç‰¹æ•ˆ
                        createFirework(meteor.x + meteor.width / 2, meteor.y + meteor.height / 2);
                        
                        if (window.explodeBullet) {
                            for (let j = meteors.length - 1; j >= 0; j--) {
                                const m = meteors[j];
                                const dx = m.x - meteor.x;
                                const dy = m.y - meteor.y;
                                if (Math.sqrt(dx*dx + dy*dy) < window.explodeRange) {
                                    gameContainer.removeChild(m.element);
                                    meteors.splice(j, 1);
                                    // ä¸ºè¿é”çˆ†ç‚¸ä¹Ÿåˆ›å»ºçƒŸèŠ±
                                    createFirework(m.x + m.width / 2, m.y + m.height / 2);
                                }
                            }
                        }
                        
                        if (window.meteorSplit) {
                            for (let s = 0; s < window.splitCount; s++) {
                                const smallMeteor = document.createElement('div');
                                smallMeteor.className = 'meteor';
                                smallMeteor.textContent = String.fromCharCode(Math.floor(Math.random() * 26) + 65);
                                smallMeteor.style.left = `${meteor.x + (s - 1) * 15}px`;
                                smallMeteor.style.top = `${meteor.y}px`;
                                smallMeteor.style.fontSize = "30px";
                                gameContainer.appendChild(smallMeteor);
                                meteors.push({
                                    element: smallMeteor,
                                    x: meteor.x + (s - 1) * 15,
                                    y: meteor.y,
                                    speed: meteor.speed + 2,
                                    width: 30,
                                    height: 30,
                                    hp: 1,
                                    maxHp: 1
                                });
                            }
                        }
                    }
                    
                    gameContainer.removeChild(missile.element);
                    missiles.splice(missileIndex, 1);
                    break;
                }
            }
        }

        // é™¨çŸ³ç¢°æ’æ£€æµ‹
        function checkMeteorCollision(meteor) {
            if (
                meteor.x < playerX + playerWidth &&
                meteor.x + meteor.width > playerX &&
                meteor.y < playerY + playerHeight &&
                meteor.y + meteor.height > playerY
            ) {
                if (window.invincible) return;
                
                if (window.shieldCount > 0) {
                    window.shieldCount -= 1;
                    gameContainer.removeChild(meteor.element);
                    meteors = meteors.filter(m => m !== meteor);
                    return;
                }
                
                gameOver();
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            
            clearInterval(distanceTimer);
            clearInterval(meteorTimer);
            clearInterval(moveTimer);
            clearInterval(reloadTimer);
            clearInterval(missileReloadTimer);
            
            if (currentDistance > maxDistance) {
                maxDistance = currentDistance;
                localStorage.setItem('planeGameMaxDistance', maxDistance);
            }
            
            document.getElementById('go-name').textContent = playerName;
            document.getElementById('go-distance').textContent = currentDistance;
            document.getElementById('go-max-distance').textContent = maxDistance;
            document.getElementById('go-talents').textContent = selectedTalents.join('ã€') || 'æ— ';
            
            gameOverPanel.style.display = "block";
        }

        // ========== é”®ç›˜æ§åˆ¶ ==========
        document.addEventListener('keydown', (e) => {
            e.preventDefault();
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
            }
            if (e.key === ' ') {
                isFiring = true;
            }
            if (e.key === 'x' || e.key === 'X') {
                isFiringMissile = true;
            }
            
            if (!gameRunning) return;
            
            if (e.key === ' ' && currentAmmo > 0) {
                fire();
            }
            if ((e.key === 'x' || e.key === 'X') && currentMissile > 0) {
                fireMissile();
            }
        }, { passive: false });

        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
            }
            if (e.key === ' ') {
                isFiring = false;
            }
            if (e.key === 'x' || e.key === 'X') {
                isFiringMissile = false;
            }
        }, { passive: true });

        // ========== äº‹ä»¶ç»‘å®š ==========
        restartBtn.addEventListener('click', initGame);
        window.onload = initGame;

        window.addEventListener('resize', () => {
            playerX = Math.min(playerX, gameContainer.clientWidth - playerWidth);
            player.style.left = `${playerX}px`;
        });

        window.addEventListener('blur', () => {
            for (let key in keys) {
                keys[key] = false;
            }
            isFiring = false;
            isFiringMissile = false;
        });
    </script>
</body>
</html>
